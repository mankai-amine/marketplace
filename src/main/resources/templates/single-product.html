<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head('Product || Single View')}"></head>
<body>
<div th:replace="~{fragments/header}"></div>

<div th:if="${message}" class="alert alert-success">
    <p th:text="${message}"></p>
</div>

<div th:if="${product}">
    <h1 th:if="${product.isDeleted} == true" class="text-danger">This product has been delisted and is not for sale.</h1>
    <h1 th:if="${product.stockAmount} == 0" class="text-warning">This product is out of stock. Please check back later.</h1>
    <h1 th:text="${product.name}"></h1>
    <table class="table table-bordered table-striped" id="productTable">
        <thead>
        <tr>
            <th>Description</th>
            <th>Price</th>
            <th># in Stock</th>
            <th>Image</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td th:text="${product.description}"></td>
            <td th:text="'$' + ${#numbers.formatDecimal(product.price, 1, 2)}"></td>
            <td th:text="${product.stockAmount}"></td>
            <td th:if="${product.imageUrl == null}">No image found.</td>
            <td th:if="${product.imageUrl}">
                <img th:src="@{${product.imageUrl}}" alt="Product Image" />
            </td>
        </tr>
        <tr>
        </tr>
        </tbody>
    </table>


    <span th:if="${#authorization.expression('isAuthenticated() and hasAuthority(''ROLE_BUYER'')')} and ${product.isDeleted == false}
    and ${product.stockAmount != 0}">
        <input type="hidden" name="productId" th:value="${product.id}"/>
        <input type="number" name="amountProd" id="amountProd" value="1"/>
        <button th:onclick="'addToCart(' + ${product.id} + ', document.getElementById(\'amountProd\').value)'" type="button">Add to Cart</button>
    </span>


    <a th:href="@{/}" class="btn btn-info">Back to All Products</a>

    <span th:if="${isSellerEqualUser}">
        <a th:href="@{/seller/{sellerId}/products(sellerId=${sellerId})}" class="btn btn-info">Back to Your Products</a>
    </span>
</div>
<script>
    function addToCart(productId, amountProd) {
        fetch(`/api/cart/add?productId=${productId}&amount=${amountProd}`, {
            method: 'POST',
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Item added', data);
                // Reload the page to reflect the updated cart
                location.reload();
            })
            .catch((error) => {
                console.error('Error:', error);
            });
    }
</script>
</body>
</html>